.affair.active-list
  %table.list.deals
    %thead
      %tr
        %th.act
          %i.icon.icon-remove
        %th= Gap.human_attribute_name(:done_at)
        %th= Gap.human_attribute_name(:deal_type)
        %th= Gap.human_attribute_name(:third)
        %th= Gap.human_attribute_name(:reference)
        %th= Gap.human_attribute_name(:amount)
    %tfoot
      %tr
        %td{colspan: 5}
          - if affair && affair.gaps.none?
            - unless affair.closed?
              - model  = default_type.underscore
              = link_to("add_#{model}".tl, {action: :select, controller: :affairs, id: affair.id, :deal_type => model, :third_id => third_id, redirect: request.fullpath}, class: "btn primary")
              = " &nbsp;&nbsp;&nbsp;&nbsp; ".html_safe
              %span.btn-group<
                - other_types.each do |type|
                  - model = type.underscore
                  = link_to("add_#{model}".tl, {action: :select, controller: :affairs, id: affair.id, :deal_type => model, :third_id => third_id, redirect: request.fullpath}, class: "btn")
              = " &nbsp;&nbsp;&nbsp;&nbsp; ".html_safe
              = link_to("convert_balance_into_#{affair.losing? ? :loss : :profit}".tl, {controller: :affairs, action: :finish, id: affair.id, redirect: request.fullpath}, method: :post, class: "btn")
        - if affair
          %td.total.amount.sum{class: (affair.balance.zero? ? "debit" : "credit")}
            = affair.balance.l(currency: affair.currency)
        - else
          %td.total.amount.sum
    - if affair
      %tbody
        - affair.deals.sort_by{ |a| a.dealt_at || a.created_at }.each do |deal|
          %tr
            %td.act
              - if !current_deal or (deal != current_deal and deal.detachable?)
                - if affair.gaps.none?
                  = link_to({action: :detach, controller: :affairs, id: deal.affair_id, :deal_type => deal.class.name.underscore, :deal_id => deal.id, redirect: request.fullpath}, method: :delete, data: {confirm: :are_you_sure.tl}, class: "remove") do
                    %i
                    = :destroy.tl
                - if deal.is_a? Gap
                  = link_to({action: :detach_gaps, controller: :affairs, id: deal.affair_id, redirect: request.fullpath}, method: :delete, data: {confirm: :are_you_sure.tl}, class: "remove") do
                    %i
                    = :destroy.tl
            %td.dat.dealt-on= deal.dealt_at.l
            %td.type= deal.class.model_name.human
            %td.third= link_to(deal.deal_third.full_name, send("backend_#{deal.deal_third.class.name.underscore}_path", deal.deal_third))
            %td.name= link_to(deal.label, controller: "/backend/"+deal.class.table_name, action: :show, id: deal.id)
            %td.amount{class: (deal.deal_debit? ? "debit" : "credit")}
              - amount = deal.deal_amount
              - amount *= -1 if deal.deal_credit?
              -# unless deal.deal_amount.zero?
                %span.sign= deal.deal_debit? ? "+" : "-"
              %span.value= amount.l(currency: deal.currency)
